<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAuto K 线图</title>
    <style>
      body {
        margin: 0;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        background: #0e1117;
        color: #e6edf3;
      }

      header {
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
      }

      h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 600;
      }

      .controls {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      select,
      input,
      button {
        background: #0d1117;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 14px;
      }

      button {
        cursor: pointer;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .control-group label {
        font-size: 13px;
        color: #c9d1d9;
      }

      .control-group input {
        width: 72px;
      }

      .content {
        padding: 16px 24px 32px;
      }

      #chart {
        width: 100%;
        height: 600px;
      }

      .meta {
        margin-top: 12px;
        font-size: 13px;
        color: #8b949e;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>KLineChart 实时 K 线展示</h1>
      <div class="controls">
        <label for="barSelect">级别</label>
        <select id="barSelect">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="30m">30m</option>
          <option value="1h">1h</option>
        </select>
        <div class="control-group">
          <label for="windowInput">窗口W</label>
          <input id="windowInput" type="number" min="1" step="1" value="60" />
        </div>
        <div class="control-group">
          <label for="multiplierInput">倍数N</label>
          <input id="multiplierInput" type="number" min="1" step="0.1" value="5" />
        </div>
        <button id="refreshBtn" type="button">刷新</button>
      </div>
    </header>
    <main class="content">
      <div id="chart"></div>
      <div class="meta" id="meta"></div>
    </main>

    <script src="/static/vendor/klinecharts.min.js"></script>
    <script>
      const meta = document.getElementById("meta");
      const barSelect = document.getElementById("barSelect");
      const refreshBtn = document.getElementById("refreshBtn");
      const windowInput = document.getElementById("windowInput");
      const multiplierInput = document.getElementById("multiplierInput");
      const chart = window.klinecharts ? klinecharts.init("chart") : null;
      const candlePaneId = "candle_pane";
      const volumePaneId = "volume_pane";
      const macdPaneId = "macd_pane";
      if (!chart) {
        meta.textContent = "KLineChart 资源加载失败，请检查静态资源是否可访问。";
      } else {
        klinecharts.registerIndicator({
          name: "VOL_SPIKE",
          shortName: "VOL异常",
          series: klinecharts.IndicatorSeries.Volume,
          calcParams: [60, 5],
          figures: [
            {
              key: "spike",
              title: "异常: ",
              type: "circle",
            },
          ],
          styles: {
            circles: [
              {
                color: "#f85149",
                borderColor: "#ff7b72",
                borderSize: 1,
                size: 4,
              },
            ],
          },
          calc: (dataList, indicator) => {
            const windowSize = Math.max(1, Math.floor(indicator.calcParams[0]));
            const multiplier = Number(indicator.calcParams[1]);
            const buffer = [];
            let sum = 0;
            return dataList.map((item) => {
              const volume = Number(item.volume) || 0;
              buffer.push(volume);
              sum += volume;
              if (buffer.length > windowSize) {
                sum -= buffer.shift();
              }
              const mean = buffer.length ? sum / buffer.length : 0;
              const spike = mean > 0 && volume > mean * multiplier ? volume : null;
              return { spike };
            });
          },
        });

        chart.createIndicator("MA", false, { id: candlePaneId });
        chart.createIndicator("VOL", false, { id: volumePaneId, height: 120 });
        chart.createIndicator("VOL_SPIKE", true, { id: volumePaneId });
        chart.createIndicator("MACD", false, { id: macdPaneId, height: 160 });
      }

      function getWindowSize() {
        const value = Math.floor(Number(windowInput.value));
        return Number.isFinite(value) && value > 0 ? value : 60;
      }

      function getMultiplier() {
        const value = Number(multiplierInput.value);
        return Number.isFinite(value) && value > 0 ? value : 5;
      }

      function updateVolumeSpikeIndicator() {
        if (!chart) {
          return;
        }
        chart.overrideIndicator(
          {
            name: "VOL_SPIKE",
            calcParams: [getWindowSize(), getMultiplier()],
          },
          volumePaneId,
        );
      }

      async function loadCandles() {
        const bar = barSelect.value;
        refreshBtn.disabled = true;
        refreshBtn.textContent = "加载中...";
        if (!chart) {
          return;
        }
        try {
          const response = await fetch(`/api/candles?bar=${bar}`);
          if (!response.ok) {
            throw new Error(`请求失败：${response.status}`);
          }
          const payload = await response.json();
          const data = payload.data.map((item) => ({
            ...item,
            timestamp: Number(item.timestamp),
            open: Number(item.open),
            high: Number(item.high),
            low: Number(item.low),
            close: Number(item.close),
            volume: Number(item.volume),
          }));
          chart.applyNewData(data);
          updateVolumeSpikeIndicator();
          meta.textContent = `标的：${payload.instId} | 周期：${payload.bar} | 根数：${payload.count}`;
        } catch (error) {
          meta.textContent = `加载失败：${error.message}`;
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.textContent = "刷新";
        }
      }

      barSelect.addEventListener("change", loadCandles);
      refreshBtn.addEventListener("click", loadCandles);
      windowInput.addEventListener("change", updateVolumeSpikeIndicator);
      multiplierInput.addEventListener("change", updateVolumeSpikeIndicator);

      loadCandles();
      setInterval(loadCandles, 15000);
    </script>
  </body>
</html>
